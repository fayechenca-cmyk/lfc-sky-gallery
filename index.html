<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LFC Sky Gallery</title>

  <style>
    html, body { margin:0; height:100%; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0a0a0c; color:#fff; overflow:hidden; }
    #app { display:flex; height:100%; width:100%; }
    #scene { flex:1; position:relative; }
    #panel { width:360px; max-width:42vw; background:rgba(10,10,12,0.88); border-left:1px solid rgba(255,255,255,0.08); display:flex; flex-direction:column; }
    #topbar { padding:14px 14px 10px; border-bottom:1px solid rgba(255,255,255,0.08); }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pill { padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.14); background:rgba(255,255,255,0.06); cursor:pointer; font-size:13px; }
    .pill.active { border-color:rgba(125,255,255,0.55); background:rgba(125,255,255,0.12); }
    .pill.primary { border-color:rgba(255,255,255,0.22); background:rgba(255,255,255,0.10); }
    .muted { opacity:0.75; font-size:12px; }
    #chat { flex:1; overflow:auto; padding:12px; display:flex; flex-direction:column; gap:10px; }
    .msg { padding:10px 12px; border-radius:14px; max-width:90%; white-space:pre-wrap; line-height:1.35; font-size:14px; }
    .msg-user { align-self:flex-end; background:rgba(125,255,255,0.15); border:1px solid rgba(125,255,255,0.18); }
    .msg-ai { align-self:flex-start; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.10); }
    #inputbar { padding:12px; border-top:1px solid rgba(255,255,255,0.08); display:flex; gap:8px; }
    #txt { flex:1; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.14); background:rgba(0,0,0,0.35); color:#fff; outline:none; }
    #send { padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.18); background:rgba(255,255,255,0.10); color:#fff; cursor:pointer; }
    #send:disabled { opacity:0.5; cursor:not-allowed; }

    #hud { position:absolute; left:12px; top:12px; display:flex; flex-direction:column; gap:10px; pointer-events:none; }
    .hudbox { pointer-events:auto; padding:10px 12px; border-radius:14px; background:rgba(0,0,0,0.35); border:1px solid rgba(255,255,255,0.10); }
    .hudtitle { font-weight:600; font-size:13px; opacity:0.9; margin-bottom:6px; }
    #elevator { display:flex; gap:6px; flex-wrap:wrap; }
    .lvlbtn { pointer-events:auto; width:34px; height:34px; border-radius:10px; display:grid; place-items:center; cursor:pointer;
      background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12); font-size:13px; }
    .lvlbtn.active { border-color:rgba(125,255,255,0.55); background:rgba(125,255,255,0.12); }

    /* modal */
    #modalBack { position:fixed; inset:0; background:rgba(0,0,0,0.65); display:none; align-items:center; justify-content:center; z-index:50; }
    #modal { width:min(920px,92vw); background:#0d0d10; border:1px solid rgba(255,255,255,0.12); border-radius:18px; overflow:hidden; }
    #modalTop { padding:14px 16px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(255,255,255,0.10); }
    #modalBody { display:grid; grid-template-columns: 1.3fr 1fr; gap:0; }
    #modalImg { background:#0a0a0c; min-height:380px; display:grid; place-items:center; }
    #modalImg img { max-width:100%; max-height:520px; object-fit:contain; }
    #modalInfo { padding:16px; }
    .h1 { font-size:18px; font-weight:650; margin:0 0 8px; }
    .kv { font-size:13px; opacity:0.85; margin:0 0 10px; }
    .close { cursor:pointer; opacity:0.85; }
    .close:hover { opacity:1; }

    /* journey */
    #journeyBack { position:fixed; inset:0; background:rgba(0,0,0,0.65); display:none; align-items:center; justify-content:center; z-index:60; }
    #journey { width:min(920px,92vw); background:#0d0d10; border:1px solid rgba(255,255,255,0.12); border-radius:18px; overflow:hidden; }
    #journeyTop { padding:14px 16px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(255,255,255,0.10); }
    #journeyBody { padding:16px; }
    .card { padding:12px 12px; border-radius:14px; border:1px solid rgba(255,255,255,0.10); background:rgba(255,255,255,0.06); margin-top:10px; }
    .btn { padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.18); background:rgba(255,255,255,0.10); color:#fff; cursor:pointer; }
    .tiny { font-size:12px; opacity:0.75; }

    @media (max-width: 860px) {
      #panel { width:320px; }
      #modalBody { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
<div id="app">
  <div id="scene">
    <div id="hud">
      <div class="hudbox">
        <div class="hudtitle">Elevator</div>
        <div id="elevator"></div>
        <div class="tiny" style="margin-top:6px; opacity:0.7;">Click a number to change floors</div>
      </div>

      <div class="hudbox">
        <div class="hudtitle">Visitor Journey</div>
        <div class="row">
          <div class="pill primary" id="openJourney">My Journey (<span id="journeyCount">0</span>)</div>
        </div>
        <div class="tiny" style="margin-top:6px; opacity:0.7;">Save insights while chatting, then generate a free plan</div>
      </div>
    </div>
  </div>

  <div id="panel">
    <div id="topbar">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div style="font-weight:700; font-size:14px;">LFC Sky Gallery</div>
          <div class="muted">Floor: <span id="floorLabel">1</span> • Click artwork to focus</div>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="pill active" id="modeDocent">Docent</div>
        <div class="pill" id="modeCurator">Curator</div>
      </div>
    </div>

    <div id="chat"></div>

    <div id="inputbar">
      <input id="txt" placeholder="Ask about the artwork (meaning, technique, context)..." />
      <button id="send">Send</button>
    </div>
  </div>
</div>

<!-- Artwork Modal -->
<div id="modalBack">
  <div id="modal">
    <div id="modalTop">
      <div style="font-weight:650;">Artwork</div>
      <div class="close" id="closeModal">✕</div>
    </div>
    <div id="modalBody">
      <div id="modalImg"><img id="modalImgEl" alt="artwork" /></div>
      <div id="modalInfo">
        <p class="h1" id="mTitle">—</p>
        <p class="kv" id="mMeta">—</p>
        <div class="row" style="margin-top:8px;">
          <button class="btn" id="focusBtn">Focus & Chat</button>
        </div>
        <div class="tiny" style="margin-top:10px;">Tip: Ask “How was this made?” or “What should I notice first?”</div>
      </div>
    </div>
  </div>
</div>

<!-- Journey Modal -->
<div id="journeyBack">
  <div id="journey">
    <div id="journeyTop">
      <div style="font-weight:650;">My Journey (Free Plan)</div>
      <div class="close" id="closeJourney">✕</div>
    </div>
    <div id="journeyBody">
      <div class="tiny">Saved insights: <span id="journeyCount2">0</span></div>

      <div class="card">
        <div style="font-weight:650; margin-bottom:6px;">Visitor Profile</div>
        <div class="row">
          <input id="ageGroup" placeholder="Age group (e.g., 13–18 / adult)" style="flex:1; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.14); background:rgba(0,0,0,0.35); color:#fff;" />
        </div>
        <div class="row" style="margin-top:8px;">
          <input id="goal" placeholder="Goal (e.g., learn contemporary art / improve composition)" style="flex:1; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.14); background:rgba(0,0,0,0.35); color:#fff;" />
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn" id="genPlan">Generate Free Plan</button>
        </div>
      </div>

      <div id="planOut" class="card" style="display:none;"></div>
    </div>
  </div>
</div>

<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

<script>
/* ======================
   1) CONFIG (ONLY HERE)
====================== */
const WORKER_BASE = "https://lfc-ai-gateway.fayechenca.workers.dev"; // <-- your Worker domain
const AI_CHAT_URL = WORKER_BASE + "/api/chat";
const AI_CURRICULUM_URL = WORKER_BASE + "/api/curriculum";

/* ======================
   2) AI GATEWAY CALLS
====================== */
async function callAIChat(payload) {
  const r = await fetch(AI_CHAT_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  const t = await r.text();
  if (!r.ok) throw new Error(t || ("AI error " + r.status));
  return JSON.parse(t);
}

async function callAICurriculum(payload) {
  const r = await fetch(AI_CURRICULUM_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  const t = await r.text();
  if (!r.ok) throw new Error(t || ("AI error " + r.status));
  return JSON.parse(t);
}

/* ======================
   3) UI HELPERS
====================== */
const chatEl = document.getElementById("chat");
function addMsg(role, text) {
  const id = "msg-" + Date.now() + "-" + Math.random().toString(16).slice(2);
  const d = document.createElement("div");
  d.className = "msg " + (role === "user" ? "msg-user" : "msg-ai");
  d.id = id;
  d.textContent = text;
  chatEl.appendChild(d);
  chatEl.scrollTop = chatEl.scrollHeight;
  return id;
}

function setMode(mode) {
  state.mode = mode;
  document.getElementById("modeDocent").classList.toggle("active", mode === "docent");
  document.getElementById("modeCurator").classList.toggle("active", mode === "curator");
}

document.getElementById("modeDocent").onclick = () => setMode("docent");
document.getElementById("modeCurator").onclick = () => setMode("curator");

/* ======================
   4) DATA
====================== */
const state = {
  mode: "docent",
  floor: 1,
  floorHeight: 26,
  currentArt: null,
  chatHistory: [], // {role:"user"|"model", text:"..."}
  savedInsights: [], // {art, tag}
  artworks: [] // loaded
};

function defaultDemoArtworks() {
  // Minimal demo if artworks.json is missing
  const demo = [];
  for (let f = 1; f <= 6; f++) {
    demo.push({ floor: f, title: "Demo Work A", artist: "LFC Collection", year: "—", img: "assets/demo1.jpg" });
    demo.push({ floor: f, title: "Demo Work B", artist: "LFC Collection", year: "—", img: "assets/demo2.jpg" });
    demo.push({ floor: f, title: "Demo Work C", artist: "LFC Collection", year: "—", img: "assets/demo3.jpg" });
  }
  return demo;
}

async function loadArtworks() {
  try {
    const r = await fetch("artworks.json", { cache: "no-store" });
    if (!r.ok) throw new Error("no artworks.json");
    const data = await r.json();
    if (!Array.isArray(data)) throw new Error("artworks.json must be an array");
    state.artworks = data;
  } catch (e) {
    console.warn("Using demo artworks:", e);
    state.artworks = defaultDemoArtworks();
  }
}

/* ======================
   5) THREE.JS SCENE
====================== */
let scene, camera, renderer, raycaster, mouse;
let levelGroup = null;
let interactables = []; // clickable meshes

function initThree() {
  const container = document.getElementById("scene");

  scene = new THREE.Scene();
  scene.fog = new THREE.Fog(0x0a0a0c, 30, 140);

  camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 500);
  camera.position.set(0, state.floor * state.floorHeight + 6, 18);

  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setSize(container.clientWidth, container.clientHeight);
  container.appendChild(renderer.domElement);

  raycaster = new THREE.Raycaster();
  mouse = new THREE.Vector2();

  // lights
  scene.add(new THREE.AmbientLight(0xffffff, 0.5));
  const dir = new THREE.DirectionalLight(0xffffff, 0.8);
  dir.position.set(10, 30, 20);
  scene.add(dir);

  window.addEventListener("resize", () => {
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
  });

  // click
  renderer.domElement.addEventListener("pointerdown", onPointerDown);
}

function onPointerDown(e) {
  const rect = renderer.domElement.getBoundingClientRect();
  mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
  mouse.y = -(((e.clientY - rect.top) / rect.height) * 2 - 1);

  raycaster.setFromCamera(mouse, camera);
  const hits = raycaster.intersectObjects(interactables, true);
  if (!hits.length) return;

  const hit = hits[0].object;
  const art = hit.userData && hit.userData.art;
  if (!art) return;

  openArtworkModal(art);
}

function buildLevel(floor) {
  // cleanup
  if (levelGroup) scene.remove(levelGroup);
  interactables = [];
  levelGroup = new THREE.Group();

  const y = floor * state.floorHeight;

  // corridor floor
  const floorMat = new THREE.MeshStandardMaterial({ color: 0x111117, roughness: 0.9, metalness: 0.0 });
  const floorMesh = new THREE.Mesh(new THREE.PlaneGeometry(46, 110), floorMat);
  floorMesh.rotation.x = -Math.PI / 2;
  floorMesh.position.set(0, y, 0);
  levelGroup.add(floorMesh);

  // walls
  const wallMat = new THREE.MeshStandardMaterial({ color: 0x0f0f14, roughness: 1.0 });
  const wallL = new THREE.Mesh(new THREE.PlaneGeometry(110, 16), wallMat);
  wallL.position.set(-23, y + 8, 0);
  wallL.rotation.y = Math.PI / 2;
  levelGroup.add(wallL);

  const wallR = new THREE.Mesh(new THREE.PlaneGeometry(110, 16), wallMat);
  wallR.position.set(23, y + 8, 0);
  wallR.rotation.y = -Math.PI / 2;
  levelGroup.add(wallR);

  // ceiling soft light strip
  const strip = new THREE.PointLight(0xffffff, 0.7, 160);
  strip.position.set(0, y + 14, 0);
  levelGroup.add(strip);

  // place artworks on both walls automatically
  const floorArts = state.artworks.filter(a => Number(a.floor) === Number(floor));
  const loader = new THREE.TextureLoader();
  loader.crossOrigin = "anonymous";

  const zStart = -48;
  const zStep = 9; // spacing along corridor
  const slotsPerSide = 11; // z -48..+42 approx
  const maxPerFloor = slotsPerSide * 2; // 22

  floorArts.slice(0, maxPerFloor).forEach((a, i) => {
    const side = (i % 2 === 0) ? "R" : "L";
    const slot = Math.floor(i / 2);
    const z = zStart + slot * zStep;

    const frameW = a.w ? Number(a.w) : 9;
    const frameH = a.h ? Number(a.h) : 6;

    const x = side === "R" ? 22.3 : -22.3;
    const rotY = side === "R" ? -Math.PI / 2 : Math.PI / 2;

    const group = new THREE.Group();
    group.position.set(x, y + 8, z);
    group.rotation.y = rotY;

    // frame
    const frame = new THREE.Mesh(
      new THREE.PlaneGeometry(frameW, frameH),
      new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.7, metalness: 0.0 })
    );
    frame.position.set(0, 0, 0);
    group.add(frame);

    // image plane slightly in front
    const imgPlane = new THREE.Mesh(
      new THREE.PlaneGeometry(frameW - 0.6, frameH - 0.6),
      new THREE.MeshStandardMaterial({ color: 0x22222a, roughness: 1.0 })
    );
    imgPlane.position.set(0, 0, 0.02);
    group.add(imgPlane);

    if (a.img) {
      loader.load(
        a.img,
        (tex) => {
          tex.anisotropy = 4;
          imgPlane.material.map = tex;
          imgPlane.material.needsUpdate = true;
        },
        undefined,
        () => {
          // If external images fail CORS, keep placeholder color
        }
      );
    }

    // clickable hitbox
    const hit = new THREE.Mesh(
      new THREE.BoxGeometry(frameW, frameH, 0.5),
      new THREE.MeshBasicMaterial({ transparent: true, opacity: 0.0 })
    );
    hit.position.set(0, 0, 0.2);
    hit.userData = { art: a };
    group.add(hit);
    interactables.push(hit);

    // small label plate (optional)
    const plate = new THREE.Mesh(
      new THREE.PlaneGeometry(frameW, 1.2),
      new THREE.MeshStandardMaterial({ color: 0x0b0b10, roughness: 1.0 })
    );
    plate.position.set(0, -(frameH/2 + 1), 0.02);
    group.add(plate);

    levelGroup.add(group);
  });

  scene.add(levelGroup);
}

function goToFloor(floor) {
  state.floor = floor;
  document.getElementById("floorLabel").textContent = floor;

  // elevator UI
  document.querySelectorAll(".lvlbtn").forEach(b => b.classList.toggle("active", Number(b.dataset.floor) === Number(floor)));

  buildLevel(floor);

  // camera move
  const targetY = floor * state.floorHeight + 6;
  new TWEEN.Tween(camera.position)
    .to({ y: targetY }, 900)
    .easing(TWEEN.Easing.Quadratic.InOut)
    .start();
}

/* ======================
   6) MODAL + FOCUS
====================== */
const modalBack = document.getElementById("modalBack");
const modalImgEl = document.getElementById("modalImgEl");
const mTitle = document.getElementById("mTitle");
const mMeta = document.getElementById("mMeta");

function openArtworkModal(art) {
  state.currentArt = art;
  mTitle.textContent = art.title || "Untitled";
  mMeta.textContent = `${art.artist || "Unknown"}  •  ${art.year || "—"}  •  Floor ${art.floor || "—"}`;
  modalImgEl.src = art.img || "";
  modalBack.style.display = "flex";
}
document.getElementById("closeModal").onclick = () => modalBack.style.display = "none";
modalBack.addEventListener("click", (e) => { if (e.target === modalBack) modalBack.style.display = "none"; });

document.getElementById("focusBtn").onclick = () => {
  modalBack.style.display = "none";
  // Reset chat for this artwork
  state.chatHistory = [];
  chatEl.innerHTML = "";
  addMsg("ai", "Hi! I’m your " + (state.mode === "curator" ? "curator" : "docent") + ". What would you like to know about this artwork?");
};

/* ======================
   7) CHAT
====================== */
const txt = document.getElementById("txt");
const sendBtn = document.getElementById("send");

async function sendMessage() {
  const message = txt.value.trim();
  if (!message) return;

  if (!state.currentArt) {
    addMsg("ai", "Please click an artwork first so I know what we’re discussing.");
    txt.value = "";
    return;
  }

  txt.value = "";
  addMsg("user", message);
  state.chatHistory.push({ role: "user", text: message });

  sendBtn.disabled = true;
  const loadingId = addMsg("ai", "…");

  try {
    const res = await callAIChat({
      mode: state.mode,
      art: {
        title: state.currentArt.title,
        artist: state.currentArt.artist,
        year: state.currentArt.year,
        floor: state.currentArt.floor
      },
      history: state.chatHistory,
      message,
      userProfile: getUserProfile()
    });

    document.getElementById(loadingId)?.remove();
    addMsg("ai", res.reply || "…");
    state.chatHistory.push({ role: "model", text: res.reply || "" });

    if (res.save) {
      const tag = res.tag || "Concept";
      const btnId = "save-" + Date.now();
      const d = document.createElement("div");
      d.className = "msg msg-ai";
      d.innerHTML = `<button class="btn" id="${btnId}">+ Save Insight (${tag})</button>`;
      chatEl.appendChild(d);
      chatEl.scrollTop = chatEl.scrollHeight;

      document.getElementById(btnId).onclick = () => {
        state.savedInsights.push({ art: state.currentArt.title || "Untitled", tag });
        updateJourneyCount();
        document.getElementById(btnId).disabled = true;
        document.getElementById(btnId).textContent = "Saved ✓";
      };
    }

  } catch (err) {
    document.getElementById(loadingId)?.remove();
    addMsg("ai", "AI gateway error. Please try again.");
    console.error(err);
  } finally {
    sendBtn.disabled = false;
  }
}

sendBtn.onclick = sendMessage;
txt.addEventListener("keydown", (e) => { if (e.key === "Enter") sendMessage(); });

/* ======================
   8) JOURNEY (FREE PLAN)
====================== */
const journeyBack = document.getElementById("journeyBack");
const planOut = document.getElementById("planOut");

document.getElementById("openJourney").onclick = () => {
  document.getElementById("journeyCount2").textContent = state.savedInsights.length;
  planOut.style.display = "none";
  journeyBack.style.display = "flex";
};
document.getElementById("closeJourney").onclick = () => journeyBack.style.display = "none";
journeyBack.addEventListener("click", (e) => { if (e.target === journeyBack) journeyBack.style.display = "none"; });

function getUserProfile() {
  return {
    age: document.getElementById("ageGroup").value.trim(),
    goal: document.getElementById("goal").value.trim()
  };
}
function updateJourneyCount() {
  document.getElementById("journeyCount").textContent = state.savedInsights.length;
  document.getElementById("journeyCount2").textContent = state.savedInsights.length;
}

document.getElementById("genPlan").onclick = async () => {
  planOut.style.display = "block";
  planOut.textContent = "Generating…";

  try {
    const plan = await callAICurriculum({
      interests: state.savedInsights,
      userProfile: getUserProfile()
    });

    planOut.innerHTML = `
      <div style="font-weight:700; font-size:16px;">${escapeHtml(plan.title || "Your LFC Journey")}</div>
      <div class="tiny" style="margin-top:6px;">${escapeHtml(plan.desc || "")}</div>
      ${(plan.steps || []).map(s => `
        <div class="card" style="margin-top:10px;">
          <div style="font-weight:650;">Level ${escapeHtml(s.level)} • ${escapeHtml(s.focus || "")}</div>
          <div class="tiny" style="margin-top:6px;">Task: ${escapeHtml(s.task || "")}</div>
          <div class="tiny">Time: ${escapeHtml(s.time || "")}</div>
        </div>
      `).join("")}
    `;
  } catch (e) {
    console.error(e);
    planOut.textContent = "AI plan error. Please try again.";
  }
};

/* ======================
   9) ELEVATOR UI
====================== */
function buildElevator(maxFloors = 10) {
  const el = document.getElementById("elevator");
  el.innerHTML = "";
  for (let i = 1; i <= maxFloors; i++) {
    const b = document.createElement("div");
    b.className = "lvlbtn";
    b.dataset.floor = i;
    b.textContent = i;
    b.onclick = () => goToFloor(i);
    el.appendChild(b);
  }
}

/* ======================
   10) START
====================== */
function escapeHtml(s) {
  return String(s ?? "").replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

async function start() {
  buildElevator(12);
  await loadArtworks();
  initThree();
  buildLevel(state.floor);
  goToFloor(1);
  setMode("docent");
  addMsg("ai", "Welcome! Click an artwork, then ask me about meaning, technique, or context.");
  animate();
}

function animate() {
  requestAnimationFrame(animate);
  TWEEN.update();
  renderer.render(scene, camera);
}

start();
</script>
</body>
</html>
